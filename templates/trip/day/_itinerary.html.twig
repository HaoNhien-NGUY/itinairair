{% if items['itinerary']|default([]) is empty %}
    {{ _self.addItem(trip, day) }}
{% else %}

    <div {{ stimulus_controller('draggable') }}>
        <form action="{{ path('app_travelitem_reorder_day_item', {trip: trip.id, day: day.id}) }}" method="POST" {{ stimulus_target('draggable', 'form')}}>
            <input type="hidden" name="ordered_items" {{ stimulus_target('draggable', 'orderedItemsInput')}}>
            <input type="hidden" name="_token" value="{{ csrf_token('itinerary_reorder') }}">
        </form>
        {% for item in items['itinerary']|default([]) %}
            <div class="draggable" data-item-id="{{ item.id }}">
                {% if loop.first %}
                    <div class="flex opacity-0 hover:opacity-100 duration-200 transition-opacity items-center">
                        <div class="relative flex items-start ml-6">
                            <div class="h-7 before:absolute before:left-1/2 before:top-0 before:bottom-0 before:border-l-2 before:border-dashed before:border-indigo-200 before:-translate-x-1/2"></div>
                            <a href="{{ path('app_travelitem_create_day_item', {trip: trip.id, day: day.id }) }}"
                               class="relative border-gray-300 hover:bg-indigo-50 bg-white rounded-lg"
                               data-turbo-frame="modal">
                                <div>
                                    <twig:ux:icon name="bx:plus" class="size-6 text-indigo-300" />
                                </div>
                            </a>
                        </div>
                    </div>
                {% elseif not loop.first %}
                    {% set prevItem = items['itinerary'][loop.index0 - 1] %}
                    <div class="[.sortable-chosen_&]:opacity-0">
                        <div class="flex items-center group">
                            <div class="relative flex items-center ml-6">
                                <div class="h-7 before:absolute before:left-1/2 before:top-0 before:bottom-0 before:border-l-2 before:border-dashed before:border-indigo-200 before:-translate-x-1/2"></div>
                                <a href="{{ path('app_travelitem_create_day_item', {trip: trip.id, day: day.id, position: item.position }) }}"
                                   class="relative border-gray-300 opacity-0 group-hover:opacity-100 transition-opacity duration-200 hover:bg-indigo-50 bg-white rounded-lg"
                                   data-turbo-frame="modal">
                                    <div>
                                        <twig:ux:icon name="bx:plus" class="size-6 text-indigo-300"/>
                                    </div>
                                </a>
                            </div>

                            <span class="shrink-0 px-4 text-gray-400 text-sm flex items-center">
                                <twig:ux:icon name="ic:baseline-directions-walk" class="size-3.5" fill="currentColor"/>
                                {% set mapsDirection = prevItem
                                    ? "https://www.google.com/maps/dir/?api=1&origin=" ~ (prevItem.place.name ~ prevItem.place.address)|url_encode ~ "&destination=" ~ (item.place.name ~ item.place.address)|url_encode
                                    : "" %}
                                <span class="ps-1 hover:underline cursor-pointer">
                                    <a href="{{ mapsDirection }}" target="_blank">Itineraire</a>
                                </span>
                            </span>
                        </div>
                    </div>
                {% endif %}

                <twig:TravelItem:List_item item="{{ item }}" newItem="{{ newItem ?? null }}" position="{{ loop.index }}"/>
            </div>

            {% if loop.last %}
                {{ _self.addItem(trip, day, item.position + 1) }}
            {% endif %}
        {% endfor %}
    </div>
{% endif %}

{% macro addItem(trip, day, position = 0) %}
    <div class="mt-6">
        <a href="{{ path('app_travelitem_create_day_item', {trip: trip.id, day: day.id, position: position }) }}"
           class="flex items-center text-gray-500 border border-gray-200 rounded-xl px-4 py-2 hover:bg-gray-100"
           data-turbo-frame="modal">
            <twig:ux:icon name="bx:plus" class="size-4 mr-2 text-gray-400"/>
            Ajouter une activit√©
        </a>
    </div>
{% endmacro %}
